apt install iptables-persistent 
apt install fail2ban

#for /var/log/kern.log
apt install rsyslog

#add rules for f2b

e /etc/iptables/rules.v4
:f2b-portscan - [0:0]
:f2b-sshd - [0:0]

#f2b
-A INPUT -j f2b-portscan
-A INPUT -j f2b-sshd
-A f2b-portscan -j RETURN
-A f2b-sshd -j RETURN

#portscan
-A INPUT -p tcp -m multiport --dports 21,22,23,25,3389,5060 -j LOG --log-prefix "PORTSCAN "
-A INPUT -p tcp -m multiport --dports 21,22,23,25,3389,5060 -j DROP


#create or copy filter for portscan
e /etc/fail2ban/filter.d/portscan.conf
[Definition]
failregex = ^.*PORTSCAN .* SRC=<HOST>
ignoreregex =

e /etc/fail2ban/jail.d/defaults-debian.conf

[DEFAULT]
ignoreip = <ip1 ip2>

[sshd]
enabled = true
filter=sshd
maxretry=3
bantime=7d
findtime=8h

[portscan]
enabled = true
filter = portscan
logpath = /var/log/kern.log
maxretry = 1
bantime = 1h
