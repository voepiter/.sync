#!/usr/bin/env/bash
# 1. Установить необходимые пакеты
apt update
apt install iptables-netflow-dkms iptables-persistent nfdump

# проверяем что грузит модуль ipt_NETFLOW на текущем ядре
modprobe ipt_NETFLOW destination=127.0.0.1:2055
lsmod |grep NETFLOW
#если нет то надо ядро понижать , например на 6.1 в /etc/default/grub
#GRUB_DEFAULT="1>2" вместо 0 , порядок ядер смотреть в grub.cfg потом update-grub


# 2. Автозагрузка модуля ipt_NETFLOW с параметрами
echo "ipt_NETFLOW" > /etc/modules-load.d/ipt_netflow.conf
echo "options ipt_NETFLOW destination=127.0.0.1:2055" > /etc/modprobe.d/ipt_netflow.conf
modprobe ipt_NETFLOW destination=127.0.0.1:2055  # проверить сразу

# 3. Настроить iptables для подсчета трафика Xray и сайтов
# OUTPUT tcp/udp sport 443 — трафик VPS -> клиент (VLESS)
iptables -I OUTPUT -p tcp --sport 443 -j NETFLOW
iptables -I OUTPUT -p udp --sport 443 -j NETFLOW

# INPUT tcp/udp dport 443 — трафик сайтов (YouTube, Instagram) -> VPS
iptables -I INPUT -p tcp --dport 443 -j NETFLOW
iptables -I INPUT -p udp --dport 443 -j NETFLOW

# OUTPUT/INPUT для WireGuard (UDP 59099)
iptables -I OUTPUT -p udp --sport 59099 -j NETFLOW
iptables -I INPUT -p udp --dport 59099 -j NETFLOW

# Сохранить правила iptables-persistent
iptables-save > /etc/iptables/rules.v4

# 4. Настроить nfcapd для сбора NetFlow
cat > /etc/systemd/system/nfcapd.service <<'EOF'
[Unit]
Description=NetFlow Collector (nfcapd)
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/nfcapd -w /var/log/netflow -b 127.0.0.1 -p 2055
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now nfcapd.service

# 5. Проверка статистики
nfdump -s dstip -R /var/log/netflow -q  # топ IP к клиентам
nfdump -s srcip -R /var/log/netflow -q  # топ сайтов -> VPS

# 6. (Опционально) ротация и сохранение итогов
cat > /usr/local/sbin/netflow_rotate.sh <<'EOF'
#!/bin/bash
LOGDIR=/var/log/netflow
ARCHIVE=/var/log/netflow/archive
mkdir -p "$ARCHIVE"

# Сохраняем статистику по dstip (клиенты)
nfdump -s dstip -R "$LOGDIR" -q > "$ARCHIVE/netflow_summary_$(date +%Y%m%d).txt"

# Архивируем старые файлы nfcapd
find "$LOGDIR" -type f -name "nfcapd.*" -mtime +1 -exec gzip {} \;
EOF

chmod +x /usr/local/sbin/netflow_rotate.sh

# Добавить в cron (раз в день)
echo "0 0 * * * /usr/local/sbin/netflow_rotate.sh" >> /etc/cron.d/netflow_rotate